<!DOCTYPE html>
<html lang="uk">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1" />
        <title>Моніторинг датчиків</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css" />
        <style>
            .card {
                text-align: center;
            }
            .value {
                font-size: 2rem;
                font-weight: bold;
            }
            .slider-box {
                padding: 10px;
                display: none;
            }
            .slider {
                width: 100%;
                margin: 10px 0;
            }
            .range-values {
                font-size: 1rem;
            }
            .switch-box {
                text-align: center;
                margin-top: 10px;
            }
            .switch-card {
                cursor: pointer;
                transition: background 0.3s, color 0.3s;
            }
            .switch-card.active {
                background: #dc3545;
                color: white;
            }
            .switch-card.active .value {
                color: white !important;
            }

            .status-card {
                background: white;
                color: black;
                transition: background 0.3s, color 0.3s;
            }
            .status-card.active {
                background: green;
                color: white;
            }
            .status-card.inactive {
                background: white;
                color: black;
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="container mt-4">
            <h2 class="text-center">Моніторинг датчиків</h2>

            <!-- Блок з датчиками -->
            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5>Температура</h5>
                        <div
                            class="value text-danger"
                            id="temperature">
                            --
                        </div>
                        <small>°C</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5>Вологість</h5>
                        <div
                            class="value text-primary"
                            id="humidity">
                            --
                        </div>
                        <small>%</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5>Рівень CO₂</h5>
                        <div
                            class="value text-success"
                            id="co2">
                            --
                        </div>
                        <small>ppm</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5>Площа зелені</h5>
                        <div
                            class="value text-warning"
                            id="greenery">
                            --
                        </div>
                        <small>см²</small>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <!-- Температура -->
                <div class="col-md-4">
                    <div
                        class="card p-3 switch-card"
                        id="card-temp"
                        onclick="toggleControl('temp')">
                        <h5>Температура</h5>
                        <div class="value text-secondary">Автоматично</div>
                    </div>
                    <div
                        class="slider-box"
                        id="slider-box-temp">
                        <h5>Температура (°C)</h5>
                        <div
                            id="slider-temp"
                            class="slider"></div>
                        <div class="range-values">
                            Мін: <span id="temp-min">15</span> °C, Макс: <span id="temp-max">30</span> °C
                        </div>
                    </div>
                </div>

                <!-- Вологість -->
                <div class="col-md-4">
                    <div
                        class="card p-3 switch-card"
                        id="card-humidity"
                        onclick="toggleControl('humidity')">
                        <h5>Вологість</h5>
                        <div class="value text-secondary">Автоматично</div>
                    </div>
                    <div
                        class="slider-box"
                        id="slider-box-humidity">
                        <h5>Вологість (%)</h5>
                        <div
                            id="slider-humidity"
                            class="slider"></div>
                        <div class="range-values">
                            Мін: <span id="humidity-min">30</span> %, Макс: <span id="humidity-max">80</span> %
                        </div>
                    </div>
                </div>

                <!-- CO2 -->
                <div class="col-md-4">
                    <div
                        class="card p-3 switch-card"
                        id="card-co2"
                        onclick="toggleControl('co2')">
                        <h5>Рівень CO₂</h5>
                        <div class="value text-secondary">Автоматично</div>
                    </div>
                    <div
                        class="slider-box"
                        id="slider-box-co2">
                        <h5>Рівень CO₂ (ppm)</h5>
                        <div
                            id="slider-co2"
                            class="slider"></div>
                        <div class="range-values">
                            Мін: <span id="co2-min">300</span> ppm, Макс: <span id="co2-max">600</span> ppm
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <div
                        class="card p-3 status-card"
                        id="status-ten">
                        <h5>ТЕН</h5>
                        <div class="value">Вимкнено</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div
                        class="card p-3 status-card"
                        id="status-light">
                        <h5>Світло</h5>
                        <div class="value">Вимкнено</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div
                        class="card p-3 status-card"
                        id="status-vent">
                        <h5>Вентиляція</h5>
                        <div class="value">Вимкнено</div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script>
            const eventSource = new EventSource('/stream');

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                document.getElementById('temperature').textContent = data.temperature;
                document.getElementById('humidity').textContent = data.humidity;
                document.getElementById('co2').textContent = data.co2;
                document.getElementById('greenery').textContent = data.greenery;

                updateStatusCard('status-ten', data.ten);
                updateStatusCard('status-light', data.light);
                updateStatusCard('status-vent', data.vent);
            };

            function updateStatusCard(id, state) {
                let card = document.getElementById(id);
                if (state) {
                    card.classList.add('active');
                    card.classList.remove('inactive');
                    card.querySelector('.value').textContent = 'Увімкнено';
                } else {
                    card.classList.add('inactive');
                    card.classList.remove('active');
                    card.querySelector('.value').textContent = 'Вимкнено';
                }
            }


            // Отправка данних слайдера
            function sendSliderData(type, min, max) {
                fetch('/set_slider', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: type,
                        min: min,
                        max: max,
                    }),
                });
            }

            // Отправка при изменении значений слайдера
            $('.slider').on('slidechange', function (event, ui) {
                let sliderType = $(this).attr('id').replace('slider-', '');
                sendSliderData(sliderType, ui.values[0], ui.values[1]);
            });

            function initSlider(id, minId, maxId, minVal, maxVal) {
                $(`#${id}`).slider({
                    range: true,
                    min: minVal,
                    max: maxVal,
                    values: [minVal, maxVal],
                    slide: function (event, ui) {
                        $(`#${minId}`).text(ui.values[0]);
                        $(`#${maxId}`).text(ui.values[1]);
                    },
                });
            }

            $(function () {
                initSlider('slider-temp', 'temp-min', 'temp-max', 15, 30);
                initSlider('slider-humidity', 'humidity-min', 'humidity-max', 30, 80);
                initSlider('slider-co2', 'co2-min', 'co2-max', 300, 600);
            });

            function toggleControl(type) {
                let card = document.getElementById(`card-${type}`);
                let isActive = card.classList.toggle('active');
                let text = card.querySelector('.value');
                text.textContent = isActive ? 'Вручну' : 'Автоматично';
                let sliderBox = document.getElementById(`slider-box-${type}`);
                sliderBox.style.display = isActive ? 'block' : 'none';
            }
        </script>
    </body>
</html>
